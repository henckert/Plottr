# TASK 1.7 Completion Summary - Venues to Sites Migration

**Date:** October 20, 2025  
**Status:** âœ… COMPLETE  
**Time Taken:** ~15 minutes

## What Was Done

Created migration `0013_migrate_venues_to_sites.ts` to preserve existing venue data during platform pivot from sports booking to field layout designer.

### Files Created
- `src/db/migrations/0013_migrate_venues_to_sites.ts` (92 lines)

## Migration Strategy

### Data Mapping
```
venues.club_id         â†’ sites.club_id         (preserved)
venues.name            â†’ sites.name            (preserved)
venues.address         â†’ sites.address         (preserved)
venues.center_point    â†’ sites.location        (renamed, same PostGIS type)
venues.bbox            â†’ sites.bbox            (preserved)
venues.created_at      â†’ sites.created_at      (preserved)
venues.updated_at      â†’ sites.updated_at      (preserved)
venues.version_token   â†’ sites.version_token   (regenerated as UUID)
```

### Fields NOT Migrated
- `venues.tz` (timezone) - Not needed in new model
- `venues.published` (boolean) - Not relevant to sites
- `venues.id` - New sequential IDs generated for sites

### New Fields in Sites
- `sites.city` - Set to NULL (not in venues table)
- `sites.state` - Set to NULL (not in venues table)
- `sites.country` - Set to 'USA' as default
- `sites.postal_code` - Set to NULL (not in venues table)
- `sites.deleted_at` - New soft delete support (NULL for all migrated sites)

## Validation Results

### âœ… Data Integrity Verified

**Before Migration:**
```sql
SELECT COUNT(*) FROM venues
-- Result: 3 venues
```

**After Migration:**
```sql
SELECT COUNT(*) FROM sites
-- Result: 3 sites âœ“
```

### âœ… Location Data Preserved

**Original Venues:**
```
ID 1: Riverside Park         | POINT(-6.2603 53.3498)  | Dublin
ID 2: Central Sports Complex | POINT(-8.4772 51.8985)  | Cork
ID 3: Willow Field           | POINT(-9.2597 53.2707)  | Galway
```

**Migrated Sites:**
```
ID 7: Riverside Park         | POINT(-6.2603 53.3498)  âœ“
ID 8: Central Sports Complex | POINT(-8.4772 51.8985)  âœ“
ID 9: Willow Field           | POINT(-9.2597 53.2707)  âœ“
```

### âœ… Bbox Data Preserved
```sql
SELECT COUNT(*) FROM sites WHERE bbox IS NOT NULL
-- Result: 3 sites with bbox âœ“ (matches 3 venues with bbox)
```

### âœ… Rollback Tested
```bash
npm run migrate:rollback
-- Result: Deleted 3 sites âœ“
-- Venues table unchanged âœ“

npm run db:migrate
-- Result: Re-migrated 3 venues successfully âœ“
-- New site IDs: 10, 11, 12 (sequential after previous 7, 8, 9)
```

## Acceptance Criteria Met

- âœ… All non-deleted venues copied to sites
- âœ… PostGIS location/bbox columns preserved correctly
- âœ… Club_id foreign keys remain valid
- âœ… No data loss (venue count = site count)
- âœ… Rollback removes migrated data cleanly

## Technical Notes

1. **Version Token Conversion:** The venues table uses `varchar(255)` for version_token, while sites uses `uuid`. Rather than attempting conversion (which could fail), the migration generates fresh UUIDs via `gen_random_uuid()`. This is safe because:
   - Old version tokens were for the booking system
   - New sites will use fresh version tokens in the field designer
   - No API clients depend on version token continuity across the pivot

2. **ID Sequence:** The migration preserves the order (via `ORDER BY v.id`) but not the actual ID values. Sites get new sequential IDs:
   - Venue ID 1 â†’ Site ID 7
   - Venue ID 2 â†’ Site ID 8
   - Venue ID 3 â†’ Site ID 9
   
   This is expected behavior since the sites table has its own `serial` primary key.

3. **Missing Address Fields:** The venues table only has a single `address` text field, while sites has structured fields (address, city, state, country, postal_code). The migration:
   - Copies full address to `sites.address`
   - Sets `city`, `state`, `postal_code` to NULL
   - Defaults `country` to 'USA'
   - Future work: Parse address strings to populate structured fields

4. **PostGIS Geography Columns:** Both tables use `geography(Point, 4326)` for location and `geography(Polygon, 4326)` for bbox, so the migration is a direct copy with no type conversion needed.

5. **Club Foreign Keys:** All 3 venues reference valid club IDs (1, 2), and the foreign key constraint from sites â†’ clubs ensures data integrity is maintained.

6. **Soft Delete Support:** The new sites table has `deleted_at` for soft deletes. All migrated sites have `deleted_at = NULL`, making them active by default.

## Migration Output

```
â†’ Migrating 3 venues to sites table...
âœ“ Migrated 3 venues to sites table
  Sample sites: 7:Riverside Park, 8:Central Sports Complex, 9:Willow Field
```

## Rollback Output

```
âœ“ Rolled back: Deleted 3 sites
```

## Comparison Query

To verify data integrity after migration:

```sql
-- Compare venues vs sites
SELECT 
  v.id as venue_id,
  v.name as venue_name,
  s.id as site_id,
  s.name as site_name,
  ST_AsText(v.center_point::geometry) as venue_location,
  ST_AsText(s.location::geometry) as site_location,
  v.club_id as venue_club,
  s.club_id as site_club
FROM venues v
LEFT JOIN sites s ON v.name = s.name AND v.club_id = s.club_id
ORDER BY v.id;
```

## Future Considerations

1. **Address Parsing:** Consider parsing the full address string to populate city/state/postal_code:
   ```typescript
   // Example: "123 River Road, Dublin 4, Ireland"
   // â†’ address: "123 River Road"
   // â†’ city: "Dublin"
   // â†’ postal_code: "Dublin 4"
   // â†’ country: "Ireland"
   ```

2. **Timezone Handling:** The venues.tz field is not migrated. If timezone information is needed for sites, it could be derived from geographic location using a timezone lookup service.

3. **Old Data Cleanup:** After verifying the migration is successful in production:
   - Consider dropping the old `venues` table
   - Or rename to `venues_archived` for historical reference
   - Update foreign keys in `pitches`, `sessions`, etc. to reference sites instead

## Test Validations Performed

1. âœ… 3 venues migrated to 3 sites (count matches)
2. âœ… Location coordinates match exactly
3. âœ… Bbox data preserved for all 3 sites
4. âœ… Club foreign keys valid (1, 2 exist in clubs table)
5. âœ… Rollback deleted all 3 sites
6. âœ… Re-migration successful (idempotent with new IDs)
7. âœ… Venues table unchanged after migration

## Next Steps

âœ… Subtask 1.1 COMPLETE (Sites)  
âœ… Subtask 1.2 COMPLETE (Layouts)  
âœ… Subtask 1.3 COMPLETE (Zones)  
âœ… Subtask 1.4 COMPLETE (Assets)  
âœ… Subtask 1.5 COMPLETE (Templates)  
âœ… Subtask 1.6 COMPLETE (ShareLinks)  
âœ… Subtask 1.7 COMPLETE (Venues â†’ Sites Migration)  
ðŸŸ¢ Proceed to Subtask 1.8: Seed Data (3 sites, 5 layouts, 20 zones, 50 assets)

---

**Ready for next subtask:** Yes  
**Blockers:** None  
**Database State:** Clean, 3 venues migrated to sites successfully  
**Progress:** 7/10 subtasks complete (70%) ðŸš€
