# Subtask 2.3 - Sites Zod Schemas - COMPLETE ✅

**Date:** October 20, 2025  
**Status:** ✅ COMPLETE  
**Time:** ~1 hour (estimated 1-2 hours)  
**Parent Task:** TASK 2 - Backend API (Sites & Layouts)

---

## Overview

Created comprehensive Zod validation schemas for Sites API with full GeoJSON support. Implements strict validation for WGS84 coordinates, closed polygon rings, and input/output data structures.

---

## Deliverables

### Files Created
- **`src/schemas/sites.schema.ts`** (120 lines) - Zod validation schemas
- **`tests/manual/test-sites-schemas.ts`** (160 lines) - Manual validation tests

### Schemas Defined

#### 1. `GeoPointSchema`
**Purpose:** Validate GeoJSON Point geometry  
**Validation Rules:**
- `type` must be literal `'Point'`
- `coordinates` must be `[longitude, latitude]` tuple
- Longitude: `-180` to `180`
- Latitude: `-90` to `90`

**Example:**
```typescript
const point = {
  type: 'Point',
  coordinates: [-6.3294, 53.3562] // Dublin, Ireland
};
const result = GeoPointSchema.safeParse(point);
// result.success = true
```

---

#### 2. `GeoPolygonSchema`
**Purpose:** Validate GeoJSON Polygon geometry  
**Validation Rules:**
- `type` must be literal `'Polygon'`
- `coordinates` must be array of rings (minimum 1 ring)
- Each ring must have minimum 4 points (3 unique + 1 closing)
- Each coordinate must be `[longitude, latitude]` with WGS84 bounds
- **Closed ring validation:** First point must equal last point (custom refine)

**Example:**
```typescript
const polygon = {
  type: 'Polygon',
  coordinates: [
    [
      [-6.33, 53.35],
      [-6.32, 53.35],
      [-6.32, 53.36],
      [-6.33, 53.36],
      [-6.33, 53.35], // ✅ Closed (matches first point)
    ]
  ]
};
const result = GeoPolygonSchema.safeParse(polygon);
// result.success = true
```

**Invalid Examples:**
```typescript
// ❌ Not closed
coordinates: [[[-6.33, 53.35], [-6.32, 53.35], [-6.32, 53.36]]]
// Error: "Polygon rings must be closed (first point must equal last point)"

// ❌ Too few points
coordinates: [[[-6.33, 53.35], [-6.32, 53.35], [-6.33, 53.35]]]
// Error: "Array must contain at least 4 element(s)"

// ❌ Longitude out of range
coordinates: [[[-200, 53.35], ...]]
// Error: "Number must be greater than or equal to -180"
```

---

#### 3. `SiteCreateSchema`
**Purpose:** Validate input for `POST /api/sites`  
**Fields:**
- `club_id` - `number` (integer, positive) **required**
- `name` - `string` (1-200 chars) **required**
- `address` - `string` (max 500 chars) *optional*
- `city` - `string` (max 100 chars) *optional*
- `state` - `string` (max 100 chars) *optional*
- `country` - `string` (max 100 chars) *optional*
- `postal_code` - `string` (max 20 chars) *optional*
- `location` - `GeoPointSchema` *optional*
- `bbox` - `GeoPolygonSchema` *optional*

**Example:**
```typescript
const createData = {
  club_id: 1,
  name: 'Phoenix Park',
  address: 'Phoenix Park, Dublin 8',
  city: 'Dublin',
  country: 'Ireland',
  location: {
    type: 'Point',
    coordinates: [-6.3294, 53.3562]
  }
};
const result = SiteCreateSchema.safeParse(createData);
// result.success = true
```

---

#### 4. `SiteUpdateSchema`
**Purpose:** Validate input for `PUT /api/sites/:id`  
**Differences from Create Schema:**
- All fields are **optional** (partial updates)
- `club_id` is **omitted** (cannot change club ownership)
- Uses `.strict()` to reject unknown fields

**Example:**
```typescript
// Valid: partial update
const updateData = {
  name: 'Updated Name',
  city: 'New City'
};
const result = SiteUpdateSchema.safeParse(updateData);
// result.success = true

// Invalid: unknown field
const invalid = {
  name: 'Updated Name',
  unknown_field: 'value'
};
const invalidResult = SiteUpdateSchema.safeParse(invalid);
// invalidResult.success = false
// Error: "Unrecognized key(s) in object: 'unknown_field'"
```

---

#### 5. `SiteResponseSchema`
**Purpose:** Validate output for `GET /api/sites/:id`  
**Fields:**
- All fields from `SiteCreateSchema`
- Plus database-generated fields:
  - `id` - `number` (integer, positive)
  - `version_token` - `string` (UUID format)
  - `created_at` - `string` (ISO 8601 datetime)
  - `updated_at` - `string` (ISO 8601 datetime)
  - `deleted_at` - `string` (ISO 8601 datetime, nullable)

**Nullable Fields:**
- `address`, `city`, `state`, `country`, `postal_code` (can be NULL in database)
- `location`, `bbox` (PostGIS columns are nullable)
- `deleted_at` (NULL for non-deleted sites)

**Example:**
```typescript
const response = {
  id: 1,
  club_id: 1,
  name: 'Phoenix Park',
  address: 'Phoenix Park, Dublin 8',
  city: 'Dublin',
  state: null,
  country: 'Ireland',
  postal_code: null,
  location: {
    type: 'Point',
    coordinates: [-6.3294, 53.3562]
  },
  bbox: null,
  version_token: '550e8400-e29b-41d4-a716-446655440000',
  created_at: '2025-10-20T10:00:00.000Z',
  updated_at: '2025-10-20T10:00:00.000Z',
  deleted_at: null
};
const result = SiteResponseSchema.safeParse(response);
// result.success = true
```

---

#### 6. `SitesListResponseSchema`
**Purpose:** Validate paginated list output for `GET /api/sites`  
**Fields:**
- `data` - `SiteResponseSchema[]` (array of sites)
- `next_cursor` - `string` *optional* (base64-encoded cursor)
- `has_more` - `boolean` (true if more pages available)

**Example:**
```typescript
const listResponse = {
  data: [
    { id: 1, club_id: 1, name: 'Site 1', /* ... */ },
    { id: 2, club_id: 1, name: 'Site 2', /* ... */ }
  ],
  next_cursor: 'Mjp5MDI1LTEwLTIwVDEwOjAwOjAwLjAwMFo=',
  has_more: true
};
const result = SitesListResponseSchema.safeParse(listResponse);
// result.success = true
```

---

### TypeScript Types Exported

All schemas export inferred TypeScript types:
```typescript
export type GeoPoint = z.infer<typeof GeoPointSchema>;
export type GeoPolygon = z.infer<typeof GeoPolygonSchema>;
export type SiteCreate = z.infer<typeof SiteCreateSchema>;
export type SiteUpdate = z.infer<typeof SiteUpdateSchema>;
export type SiteResponse = z.infer<typeof SiteResponseSchema>;
export type SitesListResponse = z.infer<typeof SitesListResponseSchema>;
```

**Usage in Controllers:**
```typescript
import { SiteCreateSchema, SiteResponse } from '@/schemas/sites.schema';

const parsed = SiteCreateSchema.safeParse(req.body);
if (!parsed.success) {
  return res.status(400).json({ errors: parsed.error.errors });
}
const data: SiteResponse = await service.create(parsed.data);
```

---

## Acceptance Criteria Validation

### ✅ GeoJSON Validation
- [x] GeoPoint validates WGS84 bounds (longitude [-180, 180], latitude [-90, 90])
- [x] GeoPolygon validates minimum 4 points per ring
- [x] GeoPolygon validates closed rings (first === last)
- [x] Coordinates are typed as tuples `[number, number]`

### ✅ Input Schemas
- [x] SiteCreateSchema validates all required fields (club_id, name)
- [x] SiteCreateSchema allows optional fields (address, location, bbox)
- [x] SiteUpdateSchema allows partial updates
- [x] SiteUpdateSchema uses strict mode (rejects unknown fields)

### ✅ Output Schemas
- [x] SiteResponseSchema includes all database fields
- [x] SiteResponseSchema validates UUID format for version_token
- [x] SiteResponseSchema validates ISO 8601 datetime strings
- [x] SitesListResponseSchema validates pagination structure

### ✅ Type Safety
- [x] All schemas export inferred TypeScript types
- [x] TypeScript compilation passes (no errors)
- [x] Manual validation tests pass (10/10 test cases)

---

## Manual Validation Tests

Created `tests/manual/test-sites-schemas.ts` with 10 test cases:

| Test | Scenario | Expected | Result |
|------|----------|----------|--------|
| 1 | Valid GeoPoint | ✅ Pass | ✅ Pass |
| 2 | Invalid GeoPoint (longitude out of range) | ❌ Fail | ✅ Fail |
| 3 | Valid GeoPolygon (closed ring) | ✅ Pass | ✅ Pass |
| 4 | Invalid GeoPolygon (not closed) | ❌ Fail | ✅ Fail |
| 5 | Valid SiteCreateSchema | ✅ Pass | ✅ Pass |
| 6 | Invalid SiteCreateSchema (name too long) | ❌ Fail | ✅ Fail |
| 7 | Valid SiteUpdateSchema (partial) | ✅ Pass | ✅ Pass |
| 8 | Invalid SiteUpdateSchema (unknown field) | ❌ Fail | ✅ Fail |
| 9 | Valid SiteResponseSchema | ✅ Pass | ✅ Pass |
| 10 | Invalid SiteResponseSchema (invalid UUID) | ❌ Fail | ✅ Fail |

**All tests passed!** ✅

---

## Validation Examples

### Field Length Validation
```typescript
// ❌ Name too long
SiteCreateSchema.safeParse({
  club_id: 1,
  name: 'A'.repeat(201) // 201 chars (max 200)
});
// Error: "String must contain at most 200 character(s)"

// ✅ Name within limit
SiteCreateSchema.safeParse({
  club_id: 1,
  name: 'A'.repeat(200) // 200 chars (exactly at max)
});
// Success
```

### UUID Validation
```typescript
// ❌ Invalid UUID format
SiteResponseSchema.safeParse({
  // ... other fields
  version_token: 'not-a-uuid'
});
// Error: "Invalid uuid"

// ✅ Valid UUID
SiteResponseSchema.safeParse({
  // ... other fields
  version_token: '550e8400-e29b-41d4-a716-446655440000'
});
// Success
```

### Datetime Validation
```typescript
// ❌ Invalid datetime format
SiteResponseSchema.safeParse({
  // ... other fields
  created_at: '2025-10-20' // Missing time
});
// Error: "Invalid datetime"

// ✅ Valid ISO 8601 datetime
SiteResponseSchema.safeParse({
  // ... other fields
  created_at: '2025-10-20T10:00:00.000Z'
});
// Success
```

---

## Integration with Existing Code

### Controller Usage Pattern
```typescript
// In src/controllers/sites.controller.ts (Subtask 2.4)
import { SiteCreateSchema, SiteUpdateSchema } from '@/schemas/sites.schema';

export async function createSite(req: Request, res: Response) {
  // Validate input
  const parsed = SiteCreateSchema.safeParse(req.body);
  if (!parsed.success) {
    return res.status(400).json({
      error: 'VALIDATION_ERROR',
      details: parsed.error.errors
    });
  }
  
  // Call service with validated data
  const site = await service.create(parsed.data);
  return res.status(201).json({ data: site });
}
```

### Service Response Validation (Optional)
```typescript
// In src/services/sites.service.ts (for extra safety)
import { SiteResponseSchema } from '@/schemas/sites.schema';

async create(data: SiteCreate): Promise<SiteResponse> {
  const site = await this.repo.create(data);
  
  // Validate repository output before returning
  const parsed = SiteResponseSchema.safeParse(site);
  if (!parsed.success) {
    throw new Error('Invalid repository output');
  }
  
  return parsed.data;
}
```

---

## Comparison with Existing Schemas

### Similar to `VenuesSchema`
- Both validate address fields (address, city, state, country)
- Both use optional location/geometry fields
- Both validate UUID version tokens

### Differs from `VenuesSchema`
- Sites use **GeoJSON** format (Point/Polygon)
- Venues use **WKT strings** (PostGIS text format)
- Sites have **stricter polygon validation** (closed ring check)
- Sites have **bbox field** for bounding box (Venues only have location)

---

## Technical Details

### Zod Custom Refinements
Used `.refine()` for closed ring validation:
```typescript
GeoPolygonSchema.refine(
  (polygon) => {
    // Check each ring
    return polygon.coordinates.every((ring) => {
      const first = ring[0];
      const last = ring[ring.length - 1];
      return first[0] === last[0] && first[1] === last[1];
    });
  },
  {
    message: 'Polygon rings must be closed (first point must equal last point)',
  }
);
```

### Strict Mode for Updates
```typescript
SiteUpdateSchema.strict(); // Rejects unknown fields
```

**Why strict mode?**
- Prevents typos in field names
- Catches client errors early (e.g., `naem` instead of `name`)
- Enforces explicit API contract

---

## Next Steps

### Immediate (Subtask 2.4)
Create `src/controllers/sites.controller.ts` with:
- HTTP request/response handlers
- Zod schema validation for all endpoints
- Pagination logic using `paginateResults()` from `src/lib/pagination.ts`
- If-Match header checks for version tokens
- Error handling with proper status codes

**Endpoints to implement:**
- `GET /api/sites` - List sites with cursor pagination
- `GET /api/sites/:id` - Get single site
- `POST /api/sites` - Create site (validate with `SiteCreateSchema`)
- `PUT /api/sites/:id` - Update site (validate with `SiteUpdateSchema`, check If-Match)
- `DELETE /api/sites/:id` - Soft delete site (check If-Match)

### Dependencies
- ✅ Repository layer (Subtask 2.1)
- ✅ Service layer (Subtask 2.2)
- ✅ Schemas layer (Subtask 2.3)
- ⏳ Controller layer (Subtask 2.4 - next)

---

## Files Modified

- **Created:** `src/schemas/sites.schema.ts` (120 lines)
- **Created:** `tests/manual/test-sites-schemas.ts` (160 lines)
- **Modified:** None

---

## Completion Checklist

- [x] All schemas defined (GeoPoint, GeoPolygon, Create, Update, Response, List)
- [x] GeoJSON validation implemented (WGS84 bounds, closed rings)
- [x] TypeScript types exported with z.infer
- [x] TypeScript compilation passes (no errors)
- [x] Manual validation tests created (10 test cases)
- [x] All manual tests passing (10/10)
- [x] Strict mode enabled for update schema
- [x] UUID validation for version_token
- [x] ISO 8601 datetime validation
- [x] Code documented with JSDoc comments
- [x] Ready for controller integration

---

**Status:** ✅ COMPLETE  
**Actual Time:** ~1 hour  
**Quality:** Production-ready  
**Next:** Subtask 2.4 - Sites Controller (HTTP handlers)

---

**Related Files:**
- Schemas: `src/schemas/sites.schema.ts`
- Tests: `tests/manual/test-sites-schemas.ts`
- Service: `src/services/sites.service.ts` (Subtask 2.2)
- Repository: `src/data/sites.repo.ts` (Subtask 2.1)
- Next Subtask: [tasks/0023-task-2-subtasks.md](./0023-task-2-subtasks.md) (Subtask 2.4)
