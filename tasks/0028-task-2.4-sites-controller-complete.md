# Subtask 2.4 - Sites Controller - COMPLETE ✅

**Date:** October 20, 2025  
**Status:** ✅ COMPLETE  
**Time:** ~1.5 hours (estimated 2-3 hours)  
**Parent Task:** TASK 2 - Backend API (Sites & Layouts)

---

## Overview

Created `SitesController` with 5 HTTP handlers for complete CRUD operations. Implements Zod validation, cursor-based pagination, version token checks, and proper error handling following the 4-layer architecture pattern.

---

## Deliverables

### File Created
- **`src/controllers/sites.controller.ts`** (220 lines)

### HTTP Endpoints Implemented

#### 1. `GET /api/sites` - List Sites
**Handler:** `listSites(req, res, next)`  
**Query Parameters:**
- `club_id` - **required** (number) - Filter sites by club
- `cursor` - *optional* (string, base64) - Pagination cursor
- `limit` - *optional* (number, 1-100, default 50) - Results per page

**Response:**
```json
{
  "data": [
    {
      "id": 1,
      "club_id": 1,
      "name": "Phoenix Park",
      "location": { "type": "Point", "coordinates": [-6.3294, 53.3562] },
      "version_token": "550e8400-e29b-41d4-a716-446655440000",
      "created_at": "2025-10-20T10:00:00.000Z",
      "updated_at": "2025-10-20T10:00:00.000Z"
    }
  ],
  "next_cursor": "Mjp5MDI1LTEwLTIwVDEwOjAwOjAwLjAwMFo=",
  "has_more": true
}
```

**Implementation Details:**
- Validates `club_id` is provided (required query param)
- Validates pagination params with `validatePaginationParams()`
- Fetches `limit+1` records to detect `has_more`
- Uses `paginateResults()` to generate cursor and slice data
- Validates response with `SitesListResponseSchema`

**Error Responses:**
- `400 MISSING_CLUB_ID` - No club_id provided
- `400 INVALID_PAGINATION` - Invalid cursor or limit

---

#### 2. `GET /api/sites/:id` - Get Single Site
**Handler:** `getSite(req, res, next)`  
**Path Parameters:**
- `id` - Site ID (number)

**Response:**
```json
{
  "data": {
    "id": 1,
    "club_id": 1,
    "name": "Phoenix Park",
    "address": "Phoenix Park, Dublin 8",
    "city": "Dublin",
    "country": "Ireland",
    "location": { "type": "Point", "coordinates": [-6.3294, 53.3562] },
    "bbox": null,
    "version_token": "550e8400-e29b-41d4-a716-446655440000",
    "created_at": "2025-10-20T10:00:00.000Z",
    "updated_at": "2025-10-20T10:00:00.000Z",
    "deleted_at": null
  }
}
```

**Implementation Details:**
- Parses ID from path params
- Validates ID is a number
- Calls `service.get()` (throws 404 if not found)
- Validates response with `SiteResponseSchema`

**Error Responses:**
- `400 INVALID_ID` - ID is not a number
- `404 SITE_NOT_FOUND` - Site doesn't exist (thrown by service)

---

#### 3. `POST /api/sites` - Create Site
**Handler:** `createSite(req, res, next)`  
**Request Body:**
```json
{
  "club_id": 1,
  "name": "Phoenix Park",
  "address": "Phoenix Park, Dublin 8",
  "city": "Dublin",
  "country": "Ireland",
  "postal_code": "D08",
  "location": {
    "type": "Point",
    "coordinates": [-6.3294, 53.3562]
  },
  "bbox": {
    "type": "Polygon",
    "coordinates": [
      [
        [-6.33, 53.35],
        [-6.32, 53.35],
        [-6.32, 53.36],
        [-6.33, 53.36],
        [-6.33, 53.35]
      ]
    ]
  }
}
```

**Response:** `201 Created` with created site data

**Implementation Details:**
- Validates request body with `SiteCreateSchema`
- Calls `service.create()` (handles geocoding if address provided)
- Validates response with `SiteResponseSchema`
- Returns `201 Created` status

**Error Responses:**
- `400 VALIDATION_ERROR` - Invalid request body (Zod errors)
- `400 INVALID_BBOX` - PostGIS polygon validation failed (thrown by service)

---

#### 4. `PUT /api/sites/:id` - Update Site
**Handler:** `updateSite(req, res, next)`  
**Path Parameters:**
- `id` - Site ID (number)

**Headers:**
- `If-Match` - **required** - Current version token (UUID)

**Request Body:** (all fields optional)
```json
{
  "name": "Updated Site Name",
  "city": "New City",
  "location": {
    "type": "Point",
    "coordinates": [-6.26, 53.35]
  }
}
```

**Response:** `200 OK` with updated site data (new version_token)

**Implementation Details:**
- Validates ID is a number
- Checks `If-Match` header is provided
- Validates request body with `SiteUpdateSchema` (strict mode)
- Calls `service.update()` (handles version token check)
- Validates response with `SiteResponseSchema`

**Error Responses:**
- `400 INVALID_ID` - ID is not a number
- `400 MISSING_IF_MATCH` - No If-Match header
- `400 VALIDATION_ERROR` - Invalid request body
- `404 SITE_NOT_FOUND` - Site doesn't exist
- `409 VERSION_CONFLICT` - Version token is stale (thrown by service)

---

#### 5. `DELETE /api/sites/:id` - Soft Delete Site
**Handler:** `deleteSite(req, res, next)`  
**Path Parameters:**
- `id` - Site ID (number)

**Headers:**
- `If-Match` - **required** - Current version token (UUID)

**Response:** `204 No Content` (empty body)

**Implementation Details:**
- Validates ID is a number
- Checks `If-Match` header is provided
- Calls `service.delete()` (handles version token check, sets deleted_at)
- Returns `204 No Content` on success

**Error Responses:**
- `400 INVALID_ID` - ID is not a number
- `400 MISSING_IF_MATCH` - No If-Match header
- `404 SITE_NOT_FOUND` - Site doesn't exist (thrown by service)
- `409 VERSION_CONFLICT` - Version token is stale (thrown by service)

---

## Acceptance Criteria Validation

### ✅ CRUD Endpoints
- [x] GET /api/sites - List with pagination
- [x] GET /api/sites/:id - Get single site
- [x] POST /api/sites - Create site
- [x] PUT /api/sites/:id - Update site
- [x] DELETE /api/sites/:id - Soft delete

### ✅ Validation
- [x] All request bodies validated with Zod schemas
- [x] All responses validated with Zod schemas
- [x] Pagination params validated
- [x] ID params validated (must be number)

### ✅ Version Token Handling
- [x] PUT requires If-Match header
- [x] DELETE requires If-Match header
- [x] Missing If-Match returns 400 error
- [x] Stale version token returns 409 (handled by service)

### ✅ Pagination
- [x] Uses cursor-based pagination (not offset)
- [x] Fetches limit+1 to detect has_more
- [x] Uses paginateResults() utility
- [x] Returns next_cursor and has_more fields

### ✅ Error Handling
- [x] All handlers wrapped in try/catch
- [x] Errors passed to next(err) for global middleware
- [x] Service errors (404, 409) bubble up correctly
- [x] Validation errors return 400 with details

### ✅ HTTP Status Codes
- [x] GET (success) - 200 OK
- [x] POST (success) - 201 Created
- [x] PUT (success) - 200 OK
- [x] DELETE (success) - 204 No Content
- [x] Validation error - 400 Bad Request
- [x] Not found - 404 Not Found
- [x] Version conflict - 409 Conflict

---

## Code Quality

### TypeScript Compliance
- ✅ Strict mode enabled
- ✅ All handlers fully typed
- ✅ No compilation errors

### Pattern Consistency
- ✅ Follows same pattern as `venues.controller.ts`
- ✅ Consistent error response format
- ✅ Consistent validation approach

### Error Handling
- ✅ All errors caught and passed to next()
- ✅ No unhandled promise rejections
- ✅ Clear error messages

---

## Comparison with `venues.controller.ts`

### Similarities
- Same handler structure (try/catch → next(err))
- Same validation approach (Zod safeParse)
- Same pagination logic (validatePaginationParams + paginateResults)
- Same version token checks (If-Match header)

### Differences
- **Sites require `club_id` query param** for list endpoint (Venues may have different filter)
- **Sites validate response schemas** (extra safety layer)
- **Sites use `SiteResponseSchema`** (Venues use `VenuesListResponseSchema` for single items)

---

## Request/Response Examples

### Example 1: Create Site with Geocoding
**Request:**
```http
POST /api/sites
Content-Type: application/json

{
  "club_id": 1,
  "name": "Griffith Park",
  "address": "4730 Crystal Springs Dr",
  "city": "Los Angeles",
  "state": "CA",
  "country": "USA"
}
```

**Service Flow:**
1. Controller validates with `SiteCreateSchema`
2. Service geocodes address via Mapbox → `{ coordinates: [-118.2981, 34.1361] }`
3. Repository inserts with `ST_GeogFromText('POINT(-118.2981 34.1361)')`

**Response:**
```http
HTTP/1.1 201 Created
Content-Type: application/json

{
  "data": {
    "id": 5,
    "club_id": 1,
    "name": "Griffith Park",
    "address": "4730 Crystal Springs Dr",
    "city": "Los Angeles",
    "state": "CA",
    "country": "USA",
    "postal_code": null,
    "location": {
      "type": "Point",
      "coordinates": [-118.2981, 34.1361]
    },
    "bbox": null,
    "version_token": "a1b2c3d4-e5f6-4789-a0b1-c2d3e4f56789",
    "created_at": "2025-10-20T12:00:00.000Z",
    "updated_at": "2025-10-20T12:00:00.000Z",
    "deleted_at": null
  }
}
```

---

### Example 2: Update Site with Version Token
**Request:**
```http
PUT /api/sites/5
If-Match: a1b2c3d4-e5f6-4789-a0b1-c2d3e4f56789
Content-Type: application/json

{
  "name": "Griffith Observatory Parking",
  "city": "Los Angeles"
}
```

**Service Flow:**
1. Controller validates If-Match header
2. Service checks `repo.checkVersionToken(5, 'a1b2c3d4-...')` → `true`
3. Repository updates and regenerates version_token

**Response:**
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "data": {
    "id": 5,
    "name": "Griffith Observatory Parking",
    "city": "Los Angeles",
    // ... other fields
    "version_token": "f9e8d7c6-b5a4-3210-9876-543210fedcba", // ← NEW TOKEN
    "updated_at": "2025-10-20T12:05:00.000Z"
  }
}
```

---

### Example 3: Version Conflict (Stale Token)
**Request:**
```http
PUT /api/sites/5
If-Match: old-stale-token-uuid
Content-Type: application/json

{ "name": "Updated Name" }
```

**Service Flow:**
1. Controller validates If-Match header
2. Service checks `repo.checkVersionToken(5, 'old-stale-token-uuid')` → `false`
3. Service throws `AppError(409, 'VERSION_CONFLICT')`

**Response:**
```http
HTTP/1.1 409 Conflict
Content-Type: application/json

{
  "error": "VERSION_CONFLICT",
  "message": "Version conflict: site was modified by another client. Please refresh and try again."
}
```

---

### Example 4: Pagination
**Request:**
```http
GET /api/sites?club_id=1&limit=2
```

**Service Flow:**
1. Controller validates pagination params
2. Fetches 3 records (limit+1 = 2+1)
3. paginateResults() detects `has_more = true`, generates `next_cursor`

**Response:**
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "data": [
    { "id": 1, "name": "Site 1", "updated_at": "2025-10-20T10:00:00.000Z", /* ... */ },
    { "id": 2, "name": "Site 2", "updated_at": "2025-10-19T15:30:00.000Z", /* ... */ }
  ],
  "next_cursor": "Mjp5MDI1LTEwLTE5VDE1OjMwOjAwLjAwMFo=",
  "has_more": true
}
```

**Next Page Request:**
```http
GET /api/sites?club_id=1&limit=2&cursor=Mjp5MDI1LTEwLTE5VDE1OjMwOjAwLjAwMFo=
```

---

## Integration Points

### Service Layer
- ✅ Calls `SitesService` methods
- ✅ Service handles business logic (geocoding, validation, version checks)
- ✅ Controller only handles HTTP concerns

### Validation Layer
- ✅ Uses Zod schemas from `src/schemas/sites.schema.ts`
- ✅ Validates both input and output
- ✅ Returns detailed error messages

### Pagination Layer
- ✅ Uses utilities from `src/lib/pagination.ts`
- ✅ Consistent pagination across all list endpoints

---

## Next Steps

### Immediate (Subtask 2.5)
Create `src/routes/sites.routes.ts` to:
- Register all 5 endpoints in Express router
- Apply middleware (auth, rate limiting, logging)
- Mount router at `/api/sites` in main app

**Example:**
```typescript
import { Router } from 'express';
import { authMiddleware } from '@/middleware/auth';
import {
  listSites,
  getSite,
  createSite,
  updateSite,
  deleteSite,
} from '@/controllers/sites.controller';

const router = Router();

router.get('/', authMiddleware, listSites);
router.get('/:id', authMiddleware, getSite);
router.post('/', authMiddleware, createSite);
router.put('/:id', authMiddleware, updateSite);
router.delete('/:id', authMiddleware, deleteSite);

export default router;
```

### Dependencies
- ✅ Repository layer (Subtask 2.1)
- ✅ Service layer (Subtask 2.2)
- ✅ Schemas layer (Subtask 2.3)
- ✅ Controller layer (Subtask 2.4)
- ⏳ Routes layer (Subtask 2.5 - next)

---

## Files Modified

- **Created:** `src/controllers/sites.controller.ts` (220 lines)
- **Modified:** None

---

## Completion Checklist

- [x] All 5 HTTP handlers implemented (list, get, create, update, delete)
- [x] Zod validation for all request bodies
- [x] Zod validation for all responses (extra safety)
- [x] Cursor-based pagination with paginateResults()
- [x] If-Match header checks for PUT/DELETE
- [x] Proper HTTP status codes (200, 201, 204, 400, 404, 409)
- [x] Error handling with try/catch → next(err)
- [x] TypeScript compilation passes (no errors)
- [x] Pattern consistency with venues.controller.ts
- [x] Code documented with JSDoc comments
- [x] Ready for route registration

---

**Status:** ✅ COMPLETE  
**Actual Time:** ~1.5 hours  
**Quality:** Production-ready  
**Next:** Subtask 2.5 - Sites Routes (Express router registration)

---

**Related Files:**
- Controller: `src/controllers/sites.controller.ts`
- Service: `src/services/sites.service.ts` (Subtask 2.2)
- Schemas: `src/schemas/sites.schema.ts` (Subtask 2.3)
- Repository: `src/data/sites.repo.ts` (Subtask 2.1)
- Pagination Utils: `src/lib/pagination.ts`
- Next Subtask: [tasks/0023-task-2-subtasks.md](./0023-task-2-subtasks.md) (Subtask 2.5)
